<!--<link rel="import" href="/components/polymer/polymer-element.html">-->
<!--<link rel="import" href="/components/iron-ajax/iron-ajax.html">-->
<!--&lt;!&ndash;<link rel="import" href="bower_components/vaadin-valo-theme/vaadin-combo-box.html">&ndash;&gt;-->
<!--<link rel="import" href="/components/vaadin-material-theme/vaadin-text-field.html">-->
<!--<link rel="import" href="/components/vaadin-combo-box/vaadin-combo-box.html">-->

<dom-module id="af-branches">
    <template>
        <style>
            :host { display: block; }
        </style>
        <!-- 1. get list of sections http://localhost/af/wiki/api.php?format=json&action=parse&prop=sections&page=Sources:ApiFusion.org/Sources/git-restful -->
        <iron-ajax  last-response="{{srcSections}}" url="[[wgScriptPath]]/api.php?format=json&action=parse&prop=sections&page=Sources:[[wgPageName]]" auto ></iron-ajax>
        <iron-ajax  last-response="{{impSections}}" url="[[wgScriptPath]]/api.php?format=json&action=parse&prop=sections&page=Sources:[[wgPageName]]" auto ></iron-ajax>

        <!-- 2. get section by # http://localhost/af/wiki/api.php?format=json&action=parse&prop=wikitext&&section=1&page=Sources:ApiFusion.org/Sources/git-restful -->
        <iron-ajax last-response="{{srcSection}}" url="[[wgScriptPath]]/api.php?format=json&action=parse&prop=text&section=[[s2n(srcSections,branch)]]&page=Sources:[[wgPageName]]"        auto></iron-ajax>
        <iron-ajax last-response="{{impSection}}" url="[[wgScriptPath]]/api.php?format=json&action=parse&prop=text&disableeditsection=true&disabletoc=true&section=[[s2n(impSections,branch)]]&page=Implementation:[[wgPageName]]" auto></iron-ajax>

        <vaadin-combo-box value="{{branch}}" label="Branch" items="[[srcSections.parse.sections]]" item-value-path="line" item-label-path="line"></vaadin-combo-box>
        <app-localstorage-document key="af-branch" data="{{branch}}"></app-localstorage-document> - [[branch]]

        <h2>Sources</h2>
        <element inner-h-t-m-l="[[s2t(srcSection)]]"></element>
        <h2>Generated docs</h2>
        <element inner-h-t-m-l="[[s2t(impSection)]]"></element>

    </template>

    <script>
        // http://localhost/af/wiki/api.php?action=parse&prop=sections&page=Sources:ApiFusion.org/Sources/git-restful/src/main/java/org/apifusion/git_restful
        define('af-branches',   [   "link-import!polymer/polymer-element.html"
                                ,   "link-import!iron-ajax/iron-ajax.html"
                                ,   "link-import!vaadin-material-theme/vaadin-text-field.html" //,   "link-import!vaadin-valo-theme/vaadin-combo-box.html"
                                ,   "link-import!vaadin-combo-box/vaadin-combo-box.html"
                                ,   "link-import!app-storage/app-localstorage/app-localstorage-document.html"
                                ],()=>
        {

/**
 * `af-branches`
 * Version control Branches selector out of Sources and Implementation namespace of ApiFusion git source import mediawiki page
 *
 * @customElement
 * @polymer
 * @demo demo/index.html
 */
class AfBranches extends Polymer.Element
{
    get defaultBranch(){ return  this._defaultBranch || "master" }
    set defaultBranch(b){ return this._defaultBranch = b }

    static get is() { return 'af-branches'; }
    static get properties()
    {
        return  {   /** {{PAGENAME}} mediawiki page (title)             */ wgPageName  : {   type: String, value: window.wgPageName   }
                ,   /** {{SCRIPTPATH}} path to mediawiki to get API url */ wgScriptPath: {   type: String, value: window.wgScriptPath }
                ,   /** selected branch to show/compare against         */ branch:
                    {   type: String
                    ,   reflectToAttribute: true
                    ,   notify: true
                    ,   value: 'master'
                    }
                };
    }
    s2n( x, branch ){ return x ? (x.parse.sections.find( el => el.line === branch ) || {number:1}).number : 1 }
    s2t( x ){ return x && x.parse && this.skipTitle( x.parse.text['*'] ) || ""    }
    skipTitle( x ){ return x.substring(x.indexOf('</h1>')+6) }
}

            window.customElements.define( AfBranches.is, AfBranches );
            return AfBranches;
        });
        require(['af-branches'], function( m )
        {
            console.log(m)
        });
    </script>
</dom-module>
